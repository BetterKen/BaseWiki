# 性能分析命令

## 1 top/htop

### 1.1 各项含义

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxtop.png)

### 1.2 对top排序

1. **按`b`高亮显示当前运行进程**

2. **按`x`高亮显示当前按照哪一个指标进行排序**

3. **按`shift+<`或`shift+>`更改排序指标**

   1. **按`M`根据驻留内存大小进行排序**
   2. **按`P`根据CPU使用百分比大小进行排序**
   3. **按`T`根据时间/累计时间进行排序**

   

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxtopsort.png)

### 1.3 查看线程

- **按`H`查看线程**
- **输入 top -Hp ${pid} 查看指定进程的线程运行情况**

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxtopH.png)

### 1.4 查看每个CPU的运行情况

- **按1查看每个CPU的运行情况**

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxtopC.png)

### 1.5 htop

**交互式的top命令,还可以用鼠标点,贼好使**

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxhtop.png)



## 2 ps/pstree

### 2.1 ps -aux

**ps -aux   列出目前所有的正在内存当中的程序**

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxps.png)



### 2.2 ps -ajx

**ps -ajx 以完整的格式显示所有的进程**



### 2.3 ps -H -p ${pid}

 **ps -H -p ${pid} 查看指定pid的所有线程**

### 2.4 stat字段含义

```shell
D  不能中断的进程（通常为IO）
R  正在运行中的进程
S  已经中断的进程，通常情况下，系统中大部分进程都是这个状态
T  已经停止或者暂停的进程，如果我们正在运行一个命令，比如说sleep 10，如果我们按一下ctrl -z 让他暂停，那么我们用ps查看就会显示T这个状态
W 这个好像是说，从内核2.6xx 以后，表示为没有足够的内存页分配
X  已经死掉的进程（这个好像从来不会出现）
Z  僵尸进程，杀不掉，打不死的垃圾进程，占系统一小点资源，不过没有关系。如果太多，就有问题了。一般不会出现。
I 　idle空闲状态
<  高优先级进程
N  低优先级进程
L   在内存中被锁了内存分页
s   主进程
l   多线程进程
+  代表在前台运行的进程
```

### 2.5 pstree

树形输出进程之间的关系

**pstree -p　显示当前所有进程的进程号和进程id**　

**pstree -p ${pid}　显示指定进程的进程号和进程id**　



```shell
ken@Ken:~/Desktop$ pstree -p 782
chrome(782)─┬─{Chrome_ChildIOT}(786)
            ├─{CompositorTileW}(790)
            ├─{CompositorTileW}(791)
            ├─{CompositorTileW}(792)
            ├─{Compositor}(789)
            ├─{Font_Proxy_Thre}(788)
            ├─{GpuMemoryThread}(787)
            ├─{MemoryInfra}(878)
            ├─{TaskSchedulerFo}(785)
            ├─{TaskSchedulerFo}(58151)
            └─{TaskSchedulerSe}(783)

```



## 3 mpstat

mpstat是MultiProcessor Statistics的缩写，是实时系统监控工具。报告CPU的一些统计信息，这些信息存放在/proc/stat文件中。在多CPUs系统里，其不但能查看所有CPU的平均状况信息，而且能够查看特定CPU的信息。

### 3.1 语法

```shell
mpstat [-P {|ALL}] [internal [count]]

参数：
    （1）-P {|ALL}：表示监控哪个CPU，在[0,cpu个数-1]中取值；  
    （2）internal：相邻的两次采样的间隔时间；
    （3）count：采样的次数，count只能和delay一起使用；

    备注：当没有参数时，mpstat则显示系统启动以后所有信息的平均值。有interval时，第一行的信息自系统启动以来的平均信息。从第二行开始，输出为前一个interval时间段的平均信息。
```

### 3.2 demo

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxmpstat.png)



## 4 iostat

### 4.1 语法

```shell
用法: iostat [ 选项 ] [ <时间间隔> [ <次数> ] ]
-c 显示CPU使用情况
-d 显示磁盘使用情况
-k 以 KB 为单位显示
-m 以 M 为单位显示
-N 显示磁盘阵列(LVM) 信息
-n 显示NFS 使用情况
-p[磁盘] 显示磁盘和分区的情况
-t 显示终端和CPU的信息
-x 显示详细信息
-V 显示版本信息

```

### 4.2 查看磁盘io

```iostat  -d -x -k  2 3```

数据显示每隔2秒刷新一次，共显示3次。

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxiostatd.png)

```shell
rrqm/s: 每秒进行 merge 的读操作数目。即 rmerge/s
wrqm/s: 每秒进行 merge 的写操作数目。即 wmerge/s
r/s: 每秒完成的读 I/O 设备次数。即 rio/s
w/s: 每秒完成的写 I/O 设备次数。即 wio/s
rsec/s: 每秒读扇区数。即 rsect/s
wsec/s: 每秒写扇区数。即 wsect/s
rkB/s: 每秒读K字节数。是 rsect/s 的一半，因为每扇区大小为512字节。
wkB/s: 每秒写K字节数。是 wsect/s 的一半。
avgrq-sz: 平均每次设备I/O操作的数据大小 (扇区)。
avgqu-sz: 平均I/O队列长度。
await: 平均每次设备I/O操作的等待时间 (毫秒)。
svctm: 平均每次设备I/O操作的服务时间 (毫秒)。
%util: 一秒中有百分之多少的时间用于 I/O 操作，即被io消耗的cpu百分比
```

- **如果 %util 接近 100%，说明产生的I/O请求太多，I/O系统已经满负荷，该磁盘可能存在瓶颈。**
- **如果 svctm 比较接近 await，说明 I/O 几乎没有等待时间；**
- **如果 await 远大于 svctm，说明I/O 队列太长，io响应太慢，则需要进行必要优化。**
- **如果avgqu-sz比较大，也表示有大量io在等待。**

### 4.3 查看CPU

```iostat -c 2 3```

数据显示每隔2秒刷新一次，共显示3次。

![](http://base422.oss-cn-beijing.aliyuncs.com/linuxiostatc.png)

```shell
%user：CPU处在用户模式下的时间百分比。
%nice：CPU处在带NICE值的用户模式下的时间百分比。
%system：CPU处在系统模式下的时间百分比。
%iowait：CPU等待输入输出完成时间的百分比。
%steal：管理程序维护另一个虚拟处理器时，虚拟CPU的无意识等待时间百分比。
%idle：CPU空闲时间百分比。
```

- **如果%iowait的值过高，表示硬盘存在I/O瓶颈**

- **%idle值高，表示CPU较空闲，如果%idle值高但系统响应慢时，有可能是CPU等待分配内存，此时应加大内存容量**

- **%idle值如果持续低于10，那么系统的CPU处理能力相对较低，表明系统中最需要解决的资源是CPU**

  

## 5 vmstat

## 6 sar

## 7 df/du



